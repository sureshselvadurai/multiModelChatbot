<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <title>Multimodal Chatbot</title>
    <script src="https://cdn.jsdelivr.net/npm/amazon-cognito-auth-js"></script>
    <script src="https://cdn.jsdelivr.net/npm/amazon-cognito-identity-js@5.0.3/dist/amazon-cognito-identity.min.js"></script>

    <script>

        // Function to handle the login redirection based on user type (Customer or Company)
        function handleSignIn() {
            // Get the selected user type

            const userType = document.querySelector('input[name="userType"]:checked').id;
            console.log("User Type Selected: ", userType);  // Log the user type (Customer/Company)
            if (userType==="customer"){
                document.cookie = `section=section3; path=/; max-age=31536000`;
                }
            if (userType==="company"){
                document.cookie = `section=section2; path=/; max-age=31536000`;
            }

        const baseUrl = "https://us-east-1ufowsma7a.auth.us-east-1.amazoncognito.com/login";
        const clientId = "1ufk9s0et127kdesbrt6lu01ed"; // App client ID
        const responseType = "code"; // We are using the authorization code flow
        const scope = "email+openid+phone"; // Scopes for the authentication
        const redirectUri = "https%3A%2F%2Fsureshraja.live"; // Redirect URI after login

        // Construct the full URL for redirection
        const loginUrl = `${baseUrl}?client_id=${clientId}&response_type=${responseType}&scope=${scope}&redirect_uri=${(redirectUri)}`;

        // Redirect to the login URL
        window.location.href = loginUrl;

        }

    function logout() {
        // Clear the local cookies
        document.cookie = "section=; path=/; max-age=0"; // Delete the cookie by setting its max-age to 0
        loadSection(); // Reload the page to reflect the cleared cookie

        // Cognito sign-out process
        const poolData = {
            UserPoolId: 'us-east-1_YourUserPoolId', // Your Cognito User Pool ID
            ClientId: '1ufk9s0et127kdesbrt6lu01ed', // Your Cognito App Client ID
        };

        const userPool = new AmazonCognitoIdentity.CognitoUserPool(poolData);
        const cognitoUser = userPool.getCurrentUser();

        if (cognitoUser != null) {
            cognitoUser.signOut(); // Sign out from Cognito
            console.log("User successfully logged out from Cognito.");
        } else {
            console.log("No user currently signed in to Cognito.");
        }

    }


    </script>

    <!--    &#45;&#45;All styles-->
    <style>
        body {
          font-family: 'Roboto', sans-serif;
          margin: 0;
          display: flex;
          flex-direction: column;
          height: 100vh;
        }
        header {
          background-color: #007bff;
          color: white;
          text-align: center;
          padding: 15px 0;
          font-size: 24px;
          box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        footer {
          background-color: #007bff;
          color: white;
          text-align: center;
          padding: 15px 0;
          position: fixed;
          width: 100%;
          bottom: 0;
        }
        .chat-container {
          flex: 1;
          display: flex;
          flex-direction: column;
          background-color: #fff;
          border-radius: 10px;
          overflow: hidden;
          height:570px;
        }
        .chat-box {
          flex: 1;
          padding: 20px;
          overflow-y: scroll;
          display: flex;
          flex-direction: column;
          gap: 15px;
        }
        .user-message, .bot-message {
          max-width: 75%;
          padding: 10px;
          border-radius: 15px;
          word-wrap: break-word;
        }
        .user-message {
          background-color: #4CAF50;
          color: white;
          align-self: flex-end;
        }
        .bot-message {
          background-color: #f1f1f1;
          color: #333;
          align-self: flex-start;
        }
        .input-area {
          display: flex;
          align-items: center;
          padding: 10px;
          border-top: 1px solid #ddd;
          background-color: #f9f9f9;
        }
        .input-area input, .input-area button, .input-area input[type="file"] {
          margin-right: 10px;
        }
        .input-area input[type="text"] {
          flex: 1;
          padding: 10px;
          border: none;
          border-radius: 20px;
          font-size: 16px;
        }
        .input-area button {
          padding: 8px 16px;
          background-color: #4CAF50;
          color: white;
          border: none;
          border-radius: 20px;
          cursor: pointer;
          font-size: 16px;
        }
        .input-area button:disabled {
          background-color: #ccc;
          cursor: not-allowed;
        }
        .button-container {
          display: flex;
          justify-content: space-around;
          margin-top: 10px;
        }
        .button-container button {
          background-color: #007bff;
          color: white;
          border: none;
          padding: 10px;
          border-radius: 8px;
          cursor: pointer;
        }
        .button-container button:hover {
          background-color: #0056b3;
        }
        .button-container button:active {
          background-color: #003f7f;
        }
        .input-area input[type="file"] {
          display: none;
        }
        .input-area label {
          background-color: #007bff;
          color: white;
          border-radius: 8px;
          padding: 8px 16px;
          cursor: pointer;
        }
        .input-area label:hover {
          background-color: #0056b3;
        }
        .preview-container {
          display: flex;
          gap: 10px;
          margin-top: 10px;
          flex-wrap: wrap;
        }
        .preview-container img, .preview-container video {
          max-width: 100px;
          max-height: 100px;
          object-fit: cover;
          border-radius: 8px;
        }
        .preview-item {
          position: relative;
        }
        .preview-item button {
          position: absolute;
          top: 5px;
          right: 5px;
          background-color: #ff4d4d;
          color: white;
          border: none;
          border-radius: 50%;
          cursor: pointer;
          padding: 5px;
        }
        .preview-item button:hover {
          background-color: #cc0000;
        }

            body {
                font-family: Arial, sans-serif;
                margin: 0;
                padding: 0;
                background-color: #f4f4f9;
                color: #333;
            }
            header {
                background-color: #4CAF50;
                color: white;
                padding: 20px;
                text-align: center;
            }
            .container {
                max-width: 600px;
                margin: 40px auto;
                padding: 20px;
                background-color: white;
                border-radius: 8px;
                box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            }
            h2 {
                text-align: center;
            }
            .login-btn {
                width: 100%;
                padding: 10px;
                margin: 10px 0;
                background-color: #4CAF50;
                color: white;
                border: none;
                border-radius: 4px;
                cursor: pointer;
                font-size: 16px;
            }
            .login-btn:hover {
                background-color: #45a049;
            }
            .description {
                text-align: center;
                margin: 20px 0;
                font-size: 18px;
            }
            .button-container {
                text-align: center;
                margin-top: 20px;
            }
            .button-container button {
                padding: 10px 20px;
                background-color: #4CAF50;
                color: white;
                border: none;
                border-radius: 4px;
                cursor: pointer;
            }
            .button-container button:hover {
                background-color: #45a049;
            }

        .section {
          display: none; /* Hide all sections by default */
          padding: 20px;
          border: 1px solid #ccc;
          margin-bottom: 20px;
        }
        #section1 {
          background-color: #f9f9f9;
        }
        #section2 {
          background-color: #e0f7fa;
        }
        #section3 {
          background-color: #f1f8e9;
        }
        .button-container {
          margin-top: 20px;
        }
        button {
          padding: 10px;
          margin: 5px;
          cursor: pointer;
        }

            body {
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                background-color: #f8f9fc;
            }

            .sidebar {
                background-color: #343a40;
                color: #fff;
            }

            .sidebar a {
                color: #adb5bd;
                display: block;
                padding: 10px 20px;
                text-decoration: none;
                transition: background-color 0.2s;
            }

            .sidebar a:hover {
                background-color: #495057;
            }

            .sidebar .active {
                background-color: #495057;
                font-weight: bold;
            }

            /* Dashboard Styles */
            .dashboard-header {
                margin-bottom: 30px;
            }

            .card {
                margin-bottom: 30px;
            }

            .status {
                margin-top: 15px;
            }
    </style>
</head>
<body>


<!-- Section 1 -->


<div id="section1" class="section">
    <header>
        <h1>Multimodal Chatbot</h1>
        <p>Provide your product details, and customers can interact with a chatbot for support.</p>
    </header>

    <div class="container">
        <h2>Login</h2>

        <div class="description">
            <label><input type="radio" name="userType" id="customer" checked> Customer</label>
            <label><input type="radio" name="userType" id="company"> Company</label>
        </div>

        <div class="button-container">
            <button class="login-btn" onclick="handleSignIn()">Sign In with Cognito</button>
        </div>
    </div>

</div>


<!-- Section 2 -->


<div id="section2" class="section">

    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <nav class="col-md-2 d-none d-md-block bg-dark sidebar">
                <div class="sidebar-sticky">
                    <h3 class="text-center mt-4 mb-4">MMChatbot</h3>
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link active" href="#upload-pdf">Upload PDFs</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#upload-images">Upload Images</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#model-training">Model Training</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#model-accuracy">Check Accuracy</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#deploy-model">Deploy Model</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#predict-image">Image Prediction</a>
                        </li>
                    </ul>
                </div>
            </nav>

            <!-- Main Dashboard Content -->
            <main role="main" class="col-md-9 ml-sm-auto col-lg-10 px-md-4">
                <div class="dashboard-header">
                    <h1 class="h2 mt-4">Dashboard</h1>
                </div>

                <!-- Upload PDFs Card -->
                <div id="upload-pdf" class="card shadow-sm">
                    <div class="card-header">
                        <h5>Upload PDF Documents</h5>
                    </div>
                    <div class="card-body">
                        <div class="form-row">
                            <div class="col-md-8">
                                <input type="file" id="uploadPDFInput" class="form-control-file" webkitdirectory
                                       directory multiple>
                            </div>
                            <div class="col-md-4">
                                <button class="btn btn-primary btn-block" onclick="uploadPDFs()">Upload PDFs</button>
                            </div>
                        </div>
                        <div id="uploadPDFStatus" class="status alert alert-secondary mt-3" role="alert"></div>
                    </div>
                </div>

                <!-- Upload Images Card -->
                <div id="upload-images" class="card shadow-sm">
                    <div class="card-header">
                        <h5>Upload Image Files</h5>
                    </div>
                    <div class="card-body">
                        <div class="form-row">
                            <div class="col-md-8">
                                <input type="file" id="uploadInput" class="form-control-file" webkitdirectory directory
                                       multiple>
                            </div>
                            <div class="col-md-4">
                                <button class="btn btn-primary btn-block" onclick="uploadImages()">Upload Images
                                </button>
                            </div>
                        </div>
                        <div id="uploadStatus" class="status alert alert-secondary mt-3" role="alert"></div>
                    </div>
                </div>

                <!-- Model Training Card -->
                <div id="model-training" class="card shadow-sm">
                    <div class="card-header">
                        <h5>Model Training</h5>
                    </div>
                    <div class="card-body">
                        <button class="btn btn-success" onclick="startTraining()">Start Model Training</button>
                    </div>
                </div>

                <!-- Check Model Accuracy Card -->
                <div id="model-accuracy" class="card shadow-sm">
                    <div class="card-header">
                        <h5>Check Model Accuracy</h5>
                    </div>
                    <div class="card-body">
                        <button class="btn btn-info mr-2" onclick="getModelAccuracy()">Get Accuracy</button>
                        <button class="btn btn-danger" onclick="stopRetrying()">Stop Checking</button>
                        <div id="accuracyStatus" class="status alert alert-secondary mt-3" role="alert"></div>
                    </div>
                </div>

                <!-- Deploy Model Card -->
                <div id="deploy-model" class="card shadow-sm">
                    <div class="card-header">
                        <h5>Deploy the Trained Model</h5>
                    </div>
                    <div class="card-body">
                        <button class="btn btn-warning" onclick="deployModel()">Deploy Model</button>
                        <div id="deployStatus" class="status alert alert-secondary mt-3" role="alert"></div>
                    </div>
                </div>

                <!-- Image Prediction Card -->
                <div id="predict-image" class="card shadow-sm">
                    <div class="card-header">
                        <h5>Predict Image</h5>
                    </div>
                    <div class="card-body">
                        <div class="form-row">
                            <div class="col-md-8">
                                <input type="file" id="predictInput" class="form-control-file" accept="image/*">
                            </div>
                            <div class="col-md-4">
                                <button class="btn btn-primary btn-block" onclick="predictImageCom()">Predict</button>
                            </div>
                        </div>
                        <div id="predictionResult" class="status alert alert-secondary mt-3" role="alert"></div>
                    </div>
                </div>
            </main>
        </div>
    </div>
    <div class="button-container">
    <button onclick="logout()">Logout (Clear Cookie)</button>
    </div>

    <!-- Bootstrap JS and dependencies -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>


    <script>
        // URLs for the API Gateway endpoints
        const uploadPdfUrl = ' https://t039lbcsrf.execute-api.us-east-1.amazonaws.com/default/uploadPdf';  // Replace with your actual endpoint URL
        const uploadUrl = 'https://admziesndc.execute-api.us-east-1.amazonaws.com/default/ImageUploadHandler';
        const predictUrl = 'https://todjiezyk8.execute-api.us-east-1.amazonaws.com/default/test';
        const trainModelUrl = 'https://4x1jaawwlg.execute-api.us-east-1.amazonaws.com/default/train_model';
        const getModelMetricsUrl = 'https://u9tuxm2uv6.execute-api.us-east-1.amazonaws.com/default/getModelMetrics';
        const deployModelUrl = 'https://fgfbfkcgsf.execute-api.us-east-1.amazonaws.com/default/deployModel';
        const uploadPredictUrl = ' https://63l1a5no21.execute-api.us-east-1.amazonaws.com/default/uploadPredictImage';
        const predictImageUrl = 'https://medy7b7k4f.execute-api.us-east-1.amazonaws.com/default/predictImage';
        let retryInterval = null;

        // Function to upload a PDF
        async function uploadPDFs() {
            const files = document.getElementById('uploadPDFInput').files;
            if (files.length === 0) {
                alert('Please select images to upload.');
                return;
            }

            document.getElementById('uploadPDFStatus').innerText = `Uploading ${files.length} PDFs...`;

            for (let i = 0; i < files.length; i++) {
                await uploadPDF(files[i], i + 1, files.length);
            }
        }


        async function uploadPDF(file, current, total) {
            const formData = new FormData();
            formData.append('image', file);

            try {
                const response = await fetch(uploadPdfUrl, {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    throw new Error('Failed to upload image');
                }

                const result = await response.json();
                document.getElementById('uploadPDFStatus').innerText = `PDF ${current} of ${total} uploaded.`;
            } catch (error) {
                console.error('Error uploading PDF:', error);
                alert('Failed to upload image.');
            }
        }

        // Existing functions for image upload, model training, etc.
        async function uploadImages() {
            const files = document.getElementById('uploadInput').files;
            if (files.length === 0) {
                alert('Please select images to upload.');
                return;
            }

            document.getElementById('uploadStatus').innerText = `Uploading ${files.length} images...`;

            for (let i = 0; i < files.length; i++) {
                await uploadImage(files[i], i + 1, files.length);
            }
        }

        // Function to upload a single image
        async function uploadImage(file, current, total) {
            const formData = new FormData();
            formData.append('image', file);

            try {
                const response = await fetch(uploadUrl, {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    throw new Error('Failed to upload image');
                }

                const result = await response.json();
                document.getElementById('uploadStatus').innerText = `Image ${current} of ${total} uploaded.`;
            } catch (error) {
                console.error('Error uploading image:', error);
                alert('Failed to upload image.');
            }
        }

        // Existing functions for starting model training, accuracy, etc.
        async function startTraining() {
            try {
                const response = await fetch(trainModelUrl, { method: 'POST' });

                if (!response.ok) {
                    throw new Error('Failed to start training');
                }

                const result = await response.json();
                alert('Model training started successfully.');
            } catch (error) {
                console.error('Error starting training:', error);
                alert('Failed to start training.');
            }
        }

        async function getModelAccuracy() {
            document.getElementById('accuracyStatus').innerText = 'Checking accuracy...';
            try {
                const response = await fetch(getModelMetricsUrl);

                if (response.ok) {
                    const data = await response.json();
                    const lastTrainAccuracy = parseFloat(data.last_train_accuracy);
                    const lastValidationAccuracy = parseFloat(data.last_validation_accuracy);

                    let accuracyMessage = `
                        Last Train Accuracy: ${lastTrainAccuracy.toFixed(2)}<br>
                        Last Validation Accuracy: ${lastValidationAccuracy.toFixed(2)}
                    `;

                    let color = '';

                    if (lastValidationAccuracy >= 0.80) {
                        color = 'green';
                    } else if (lastValidationAccuracy >= 0.50) {
                        color = 'yellow';
                    } else {
                        color = 'red';
                    }

                    document.getElementById('accuracyStatus').innerHTML = accuracyMessage;
                    document.getElementById('accuracyStatus').style.color = color;
                } else {
                    document.getElementById('accuracyStatus').innerText = 'Model doesnt exist, retrying in 2 minutes...';
                    retryInterval = setInterval(async () => {
                        const retryResponse = await fetch(getModelMetricsUrl);
                        if (retryResponse.ok) {
                            const data = await retryResponse.json();
                            const lastTrainAccuracy = parseFloat(data.last_train_accuracy);
                            const lastValidationAccuracy = parseFloat(data.last_validation_accuracy);

                            let accuracyMessage = `
                                Last Train Accuracy: ${lastTrainAccuracy.toFixed(2)}<br>
                                Last Validation Accuracy: ${lastValidationAccuracy.toFixed(2)}
                            `;

                            let color = '';

                            if (lastValidationAccuracy >= 0.80) {
                                color = 'green';
                            } else if (lastValidationAccuracy >= 0.50) {
                                color = 'yellow';
                            } else {
                                color = 'red';
                            }

                            document.getElementById('accuracyStatus').innerHTML = accuracyMessage;
                            document.getElementById('accuracyStatus').style.color = color;
                            clearInterval(retryInterval);
                        }
                    }, 120000); // Retry every 2 minutes
                }
            } catch (error) {
                console.error('Error getting model accuracy:', error);
                document.getElementById('accuracyStatus').innerText = 'Error fetching model accuracy.';
            }
        }

        function stopRetrying() {
            if (retryInterval) {
                clearInterval(retryInterval);
                document.getElementById('accuracyStatus').innerText = 'Stopped retrying model accuracy.';
            }
        }

        async function deployModel() {
            try {
                document.getElementById('deployStatus').innerText = 'Deploying model...';
                const response = await fetch(deployModelUrl, { method: 'POST' });

                if (response.ok) {
                    const result = await response.json();
                    document.getElementById('deployStatus').innerText = 'Model deployed successfully. Deployment ID: ' + result.deploymentId;
                    document.getElementById('deployStatus').style.color = 'green';
                } else {
                    throw new Error('Failed to deploy model');
                }
            } catch (error) {
                console.error('Error deploying model:', error);
                document.getElementById('deployStatus').innerText = 'Failed to deploy model.';
                document.getElementById('deployStatus').style.color = 'red';
            }
        }

        async function predictImageCom() {
            const file = document.getElementById('predictInput').files[0];
            if (!file) {
                alert('Please select an image to predict.');
                return;
            }

            const formData = new FormData();
            formData.append('image', file);

            try {
                const response = await fetch(uploadPredictUrl, { method: 'POST', body: formData });

                if (!response.ok) {
                    throw new Error('Prediction failed');
                }

                const responsep = await fetch(predictImageUrl, { method: 'POST' });

                if (!responsep.ok) {
                    throw new Error('Prediction failed');
                }

                const result = await responsep.json();

                let predictionText = 'Prediction: ';

                result.PredictionResult.forEach(item => {
                    predictionText += `${item.label} (Probability: ${item.probability}), `;
                });

                predictionText = predictionText.slice(0, -2);
                document.getElementById('predictionResult').innerText = predictionText;

            } catch (error) {
                console.error('Error predicting image:', error);
                alert('Failed to predict image.');
            }
        }
    </script>

</div>


<!-- Section 3 -->


<div id="section3" class="section">
    <header>
        Chatbot Assistant
    </header>

    <div class="chat-container">
        <div class="chat-box" id="chatBox">
            <div class="bot-message">Hi! How can I assist you today?</div>
        </div>

        <div class="preview-container" id="previewContainer"></div>

        <div class="input-area">
            <input type="text" id="userInput" placeholder="Type a message..."/>
            <button id="sendMessage" onclick="sendMessage()">Send</button>
            <input type="file" id="fileInput" multiple onchange="handleFileInput()"/>
            <button id="start-btn">Start Voice Input</button>
            <label for="fileInput">Upload Files</label>

        </div>
    </div>
    <div class="button-container">
    <button onclick="logout()">Logout (Clear Cookie)</button>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js"></script>
    <script>
        let filesToSend = [];

        // Function to extract frames from video
        function extractFramesFromVideo(videoFile) {
          return new Promise((resolve, reject) => {
            const video = document.createElement('video');
            video.src = URL.createObjectURL(videoFile);
            video.load();

            video.onloadeddata = () => {
              const frames = [];
              const canvas = document.createElement('canvas');
              const context = canvas.getContext('2d');

              // Set canvas dimensions to match the video
              canvas.width = video.videoWidth;
              canvas.height = video.videoHeight;

              let currentTime = 0;
              const interval = 3.5; // 3.5 seconds between frames

              // Function to capture a frame at the current video time
              const captureFrame = () => {
                context.drawImage(video, 0, 0, canvas.width, canvas.height);
                frames.push(canvas.toDataURL('image/jpeg')); // Capture frame as base64 image

                currentTime += interval;
                if (currentTime < video.duration) {
                  video.currentTime = currentTime; // Move to the next frame time
                } else {
                  resolve(frames); // All frames are captured
                }
              };

              video.onseeked = captureFrame;
              video.currentTime = currentTime; // Start frame extraction
            };

            video.onerror = (err) => {
              reject('Error processing video file: ' + err.message);
            };
          });
        }

      async function predictVideo(frames) {
        const uploadPredictUrl = 'https://63l1a5no21.execute-api.us-east-1.amazonaws.com/default/uploadPredictImage';
        const predictImageUrl = 'https://medy7b7k4f.execute-api.us-east-1.amazonaws.com/default/predictImage';

        // This will hold predictions for each frame
        let predictions = [];

        for (let i = 0; i < frames.length; i++) {
          const frame = frames[i];

          try {
            // Create FormData for the frame
            const formData = new FormData();
            formData.append('image', dataURLtoBlob(frame)); // Convert base64 to Blob

            // Upload the frame
            const uploadResponse = await fetch(uploadPredictUrl, { method: 'POST', body: formData });
            if (!uploadResponse.ok) {
              throw new Error('Frame upload failed');
            }

            // After successful upload, make prediction request
            const predictResponse = await fetch(predictImageUrl, { method: 'POST' });
            if (!predictResponse.ok) {
              throw new Error('Prediction failed');
            }

            // Get prediction result
            const result = await predictResponse.json();
            let predictionText = 'Prediction: \n';
            result.PredictionResult.forEach(item => {
              predictionText += `${item.label} : (Probability: ${item.probability}), `;
            });

            // Remove the last comma and space, add to predictions
            predictions.push(predictionText.slice(0, -2));

          } catch (error) {
            console.error('Error predicting video frame:', error);
            predictions.push('Error predicting frame');
          }
        }
        return predictions;
      }

      function dataURLtoBlob(dataURL) {
        const byteString = atob(dataURL.split(',')[1]); // Decode base64
        const mimeString = dataURL.split(',')[0].split(':')[1].split(';')[0]; // Get MIME type

        const arrayBuffer = new ArrayBuffer(byteString.length);
        const uint8Array = new Uint8Array(arrayBuffer);

        for (let i = 0; i < byteString.length; i++) {
          uint8Array[i] = byteString.charCodeAt(i);
        }

        return new Blob([arrayBuffer], { type: mimeString });
      }
        // Function to predict image
        async function predictImage(file) {
          const formData = new FormData();
          formData.append('image', file);
          const uploadPredictUrl = 'https://63l1a5no21.execute-api.us-east-1.amazonaws.com/default/uploadPredictImage';
          const predictImageUrl = 'https://medy7b7k4f.execute-api.us-east-1.amazonaws.com/default/predictImage';

          try {
            const response = await fetch(uploadPredictUrl, { method: 'POST', body: formData });
            if (!response.ok) {
              throw new Error('Prediction failed');
            }

            const responsep = await fetch(predictImageUrl, { method: 'POST' });
            if (!responsep.ok) {
              throw new Error('Prediction failed');
            }

            const result = await responsep.json();
            let predictionText = 'Prediction: ';
            result.PredictionResult.forEach(item => {
              predictionText += `${item.label} (Probability: ${item.probability}), `;
            });

            return predictionText.slice(0, -2);
          } catch (error) {
            console.error('Error predicting image:', error);
            return 'Error predicting image.';
          }
        }

        async function uploadFramesToLambda(frames) {
          const apiUrl = 'https://your-api-gateway-url.amazonaws.com/your-endpoint';

          try {
            // Send frames as a JSON payload
            const response = await fetch(apiUrl, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify(frames)  // Send frames array as JSON
            });

            const data = await response.json();
            console.log('Frames upload response:', data);
            return data; // Return response for further processing if needed
          } catch (error) {
            console.error('Error uploading frames to Lambda:', error);
          }
        }
        // Function to send the message
        async function sendMessage() {
          const userInput = document.getElementById("userInput");
          const userMessage = userInput.value.trim();

          if (userMessage === "" && filesToSend.length === 0) return;

          // Fetch PDF file data and add it to the message (optional)
          const pdfFiles = await fetchCatalogData();
          let catalogInfo = '';
          pdfFiles['pdf_files'].forEach(pdf => {
            catalogInfo += `Catalog File: ${pdf.file_name}\nContent: ${pdf.content}\n\n`;
          });

          // Process image predictions
          let imagePredictions = [];
          const imagePromises = filesToSend.map(async (file) => {
            if (file.type.startsWith('image')) {
              const predictionText = await predictImage(file);
              imagePredictions.push({
                fileName: file.name,
                prediction: predictionText,
              });
            }
          });

          // Process video predictions (split frames and predict)
          let videoPredictions = [];
          const videoPromises = filesToSend.map(async (file) => {
            if (file.type.startsWith('video')) {
              const frames = await extractFramesFromVideo(file); // Function to extract frames every 3.5s

              // Predict each frame from the video
              const framePredictions = await predictVideo(frames);

              videoPredictions.push({
                fileName: file.name,
                predictions: framePredictions, // Array of frame predictions
              });
            }
          });

          // Wait for all predictions to complete
          await Promise.all([...imagePromises, ...videoPromises]);

          // Organize data to send to API
          const dataToSend = {
            userText: userMessage,
            imagePredictions: imagePredictions,
            videoPredictions: videoPredictions,
            catalogInfo:catalogInfo
          };

          console.log("dataToSend: ",dataToSend)

          // Send data to the API
          let reply = "System Down. Try after sometime";
          try {
            const response = await fetch('https://1oh2gyhifc.execute-api.us-east-1.amazonaws.com/default/interfaceGemini', {
              method: 'POST',
              body: JSON.stringify(dataToSend),
            });

            if (!response.ok) {
              throw new Error('Failed to send data to the API');
            }
            const result = await response.json();
            reply = result.response;

            console.log('Data successfully sent to the API:', dataToSend);
          } catch (error) {
            console.error('Error sending data to the API:', error);
          }

          // Display the user's message and predictions in the chat
          const chatBox = document.getElementById("chatBox");
          const userMessageDiv = document.createElement("div");
          userMessageDiv.classList.add("user-message");
          userMessageDiv.textContent = userMessage;
          chatBox.appendChild(userMessageDiv);

          // Clear input field and reset state
          userInput.value = "";
          filesToSend = [];
          document.getElementById("previewContainer").innerHTML = '';

          // Simulate bot response
          setTimeout(() => {
            const botMessageDiv = document.createElement("div");
            botMessageDiv.classList.add("bot-message");
            botMessageDiv.textContent = reply;
            chatBox.appendChild(botMessageDiv);
            chatBox.scrollTop = chatBox.scrollHeight;
          }, 1000);
        }


        async function processFilesAndMessage(userMessage) {
          const pdfFiles = await fetchCatalogData();
          console.log("pdfFiles",pdfFiles)
          let catalogInfo = '';
          pdfFiles['pdf_files'].forEach(pdf => {
            catalogInfo += `Catalog File: ${pdf.file_name}\nContent: ${pdf.content}\n\n`;
          });

          let imageInfo = '';
          let videoInfo = '';
          const imagePromises = filesToSend.map(async (file) => {
            if (file.type.startsWith('image')) {
              const predictionText = await predictImage(file);
              imageInfo += `Image: ${file.name}\n${predictionText}\n\n`;
            } else if (file.type.startsWith('video')) {
              // Extract frames from video
              const frames = await extractFramesFromVideo(file);
              const framePredictionPromises = frames.map(async (frameData, index) => {
                let frameFile = dataURLtoFile(frameData, `frame${index + 1}.jpg`);
                const predictionText = await predictImage(frameFile);
                videoInfo += `Frame ${index + 1}: ${predictionText}\n\n`;
              });

              await Promise.all(framePredictionPromises);
            }
          });

          await Promise.all(imagePromises);

          return `${userMessage}\n\n${catalogInfo}${imageInfo}${videoInfo}`;
        }

        // Convert DataURL to file
        function dataURLtoFile(dataURL, filename) {
          const arr = dataURL.split(',');
          const mime = arr[0].match(/:(.*?);/)[1];
          const bstr = atob(arr[1]);
          const n = bstr.length;
          const u8arr = new Uint8Array(n);
          // Do not modify 'arr' or 'bstr' later
          for (let i = 0; i < n; i++) {
            u8arr[i] = bstr.charCodeAt(i);
          }
          return new File([u8arr], filename, { type: mime });
        }


        function handleFileInput() {
          const fileInput = document.getElementById("fileInput");
          filesToSend = Array.from(fileInput.files);

          const previewContainer = document.getElementById("previewContainer");
          previewContainer.innerHTML = '';

          filesToSend.forEach(file => {
            const previewItem = document.createElement("div");
            previewItem.classList.add("preview-item");

            if (file.type.startsWith('image')) {
              const img = document.createElement("img");
              img.src = URL.createObjectURL(file);
              img.style.maxWidth = "100px";
              img.style.maxHeight = "100px";
              previewItem.appendChild(img);
            } else if (file.type.startsWith('video')) {
              const video = document.createElement("video");
              video.src = URL.createObjectURL(file);
              video.style.maxWidth = "100px";
              video.controls = true;
              previewItem.appendChild(video);
            } else {
              const textFile = document.createElement("span");
              textFile.textContent = `File: ${file.name}`;
              previewItem.appendChild(textFile);
            }

            const removeButton = document.createElement("button");
            removeButton.textContent = "X";
            removeButton.onclick = () => {
              filesToSend = filesToSend.filter(f => f !== file);
              previewItem.remove();
            };
            previewItem.appendChild(removeButton);
            previewContainer.appendChild(previewItem);
          });
        }

        async function fetchCatalogData() {
          const response = await fetch('https://bc7n4fywv6.execute-api.us-east-1.amazonaws.com/default/getPDFFilesFromDatabase');
          const data = await response.json();
          return data;
        }


            const isSpeechRecognitionSupported = 'SpeechRecognition' in window || 'webkitSpeechRecognition' in window;

    if (!isSpeechRecognitionSupported) {
            alert('Your browser does not support speech recognition. Please try with a modern browser.');
        }

        const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
        recognition.lang = 'en-US'; // Set the language for speech recognition
        recognition.continuous = true; // Keep recognition going even after pauses
        recognition.interimResults = true; // Show interim results while speech is being processed

        // Get DOM elements
        const startBtn = document.getElementById('start-btn');
        const userInput = document.getElementById('userInput');

        // Start recording when the button is clicked
        startBtn.addEventListener('click', () => {
            recognition.start();
            userInput.placeholder = 'Listening...'; // Show listening text
        });

        // Capture the results of the speech recognition
        recognition.onresult = (event) => {
            let transcript = '';
            for (let i = event.resultIndex; i < event.results.length; i++) {
                transcript += event.results[i][0].transcript;
            }
            userInput.value = transcript; // Add the transcribed text to the input field
        };

        // Handle errors
        recognition.onerror = (event) => {
            console.error('Speech recognition error', event.error);
            userInput.placeholder = 'Error in speech recognition';
        };

        // Reset the transcription on recognition end
        recognition.onend = () => {
            userInput.placeholder = 'You can speak now or type...';
        };
    </script>
</div>

<!-- Buttons to simulate setting cookies -->
<!--<div class="button-container">-->
<!--    <button onclick="setSectionCookie('section1')">Show Section 1</button>-->
<!--    <button onclick="setSectionCookie('section2')">Show Section 2</button>-->
<!--    <button onclick="setSectionCookie('section3')">Show Section 3</button>-->
<!--</div>-->



<script>
    // Function to set the cookie
    function setSectionCookie(section) {
      console.log("Cookie changes to :",section)
      document.cookie = `section=${section}; path=/; max-age=31536000`; // cookie lasts for 1 year
       // Reload the page to reflect the cookie change
    }

    // Function to get the cookie value by name
    function getCookie(name) {
      const value = "; " + document.cookie;
      const parts = value.split("; " + name + "=");
      if (parts.length === 2) return parts.pop().split(";").shift();
      return null;
    }

    // Function to display the section based on the cookie value
    function loadSection() {
      const sectionToShow = getCookie('section'); // Read cookie value (e.g., 'section1', 'section2', or 'section3')

      // Hide all sections
      const sections = document.querySelectorAll('.section');
      sections.forEach(section => {
        section.style.display = 'none';
      });

      // Show the selected section
      if (sectionToShow) {
        const selectedSection = document.getElementById(sectionToShow);
        if (selectedSection) {
          selectedSection.style.display = 'block';
        }
      } else {
        // Default behavior if no cookie is set (e.g., show section1)
        document.getElementById('section1').style.display = 'block';
      }
    }

    // Call the loadSection function when the page loads
    window.onload = loadSection;
</script>

</body>
</html>
